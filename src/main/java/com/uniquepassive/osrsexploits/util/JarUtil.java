package com.uniquepassive.osrsexploits.util;

import org.objectweb.asm.ClassReader;
import org.objectweb.asm.tree.ClassNode;

import java.io.IOException;
import java.io.InputStream;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.Map;
import java.util.jar.JarEntry;
import java.util.jar.JarFile;

public class JarUtil {

    public static Map<String, ClassNode> readJar(JarFile file) throws IOException {
        return readJar(file, true);
    }

    public static Map<String, ClassNode> readJar(JarFile file, boolean skipDebug) throws IOException {
        Map<String, ClassNode> classes = new HashMap<>();

        Enumeration<JarEntry> entries = file.entries();

        while (entries.hasMoreElements()) {
            JarEntry entry = entries.nextElement();

            String name = entry.getName();

            if (name.endsWith(".class")) {
                try (InputStream inputStream = file.getInputStream(entry)) {
                    ClassReader reader = new ClassReader(inputStream);

                    ClassNode node = new ClassNode();
                    reader.accept(node, (skipDebug ? ClassReader.SKIP_DEBUG : 0) | ClassReader.SKIP_FRAMES);

                    classes.put(node.name, node);
                }
            }
        }

        return classes;
    }
}
